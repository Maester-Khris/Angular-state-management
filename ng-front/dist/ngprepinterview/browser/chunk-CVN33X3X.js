import{b as p}from"./chunk-AQN3XIJ3.js";import{$ as l,A as n,B as a,R as r,W as c,g as s}from"./chunk-TWOTJYLF.js";var f=class o{eventBus=new s;batchSub;localBuffer=[];http=l(p);constructor(){this.batchSub=this.eventBus.pipe(r(t=>this.localBuffer.push(t)),a(1e4,void 0,20),n(t=>t.length>0)).subscribe(t=>this.dispactchBatch(t))}emit(t){console.log(`Event ${t.type} added to bus`),this.eventBus.next(t)}dispactchBatch(t){let e={events:t,batchId:crypto.randomUUID(),sentAt:Date.now()};this.http.post("/api/analytics/batch",e).subscribe({next:()=>{this.localBuffer=this.localBuffer.filter(i=>!t.includes(i))},error:i=>{console.error("Batch sync failed",i)}})}flushWithBeacon(t){if(t.length>0){let e=new Blob([JSON.stringify(t)],{type:"application/json"});navigator.sendBeacon("/api/analytics/flush",e)}}onUnload(){this.flushWithBeacon(this.localBuffer)}ngOnDestroy(){this.batchSub?.unsubscribe()}static \u0275fac=function(e){return new(e||o)};static \u0275prov=c({token:o,factory:o.\u0275fac,providedIn:"root"})};export{f as a};
